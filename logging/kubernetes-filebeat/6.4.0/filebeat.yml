################### Filebeat Configuration Example #########################

############################# Filebeat ######################################
filebeat:
  # List of prospectors to fetch data.
  inputs:
    # Each - is a prospector. Below are the prospector specific configurations
    -
      # Type of prospector is docker
      type: docker

      # Containers configuration
      containers.ids:
      - "*"
      # containers.path: "/var/lib/docker/containers"

      # Array of Regex rules to filter out lines
      # This is useful for extremly noisy containers,
      # With little logging value : Such as rancher ipsec-router
      exclude_lines: ["${LOG_EXCLUDE_LINE}"]

      # Configure the file encoding for reading files with international characters
      # following the W3C recommendation for HTML5 (http://www.w3.org/TR/encoding).
      # Some sample encodings:
      #   plain, utf-8, utf-16be-bom, utf-16be, utf-16le, big5, gb18030, gbk,
      #    hz-gb-2312, euc-kr, euc-jp, iso-2022-jp, shift-jis, ...
      encoding: utf-8

      # A single log line maximum bytes
      # 250,000 bytes was selected, so that 20 log lines
      # would be under 10MB with some format overhead.
      max_bytes: ${LOG_LINE_MAX}

      # Ignore files which were modified more then the defined timespan in the past
      # Time strings like 2h (2 hours), 5m (5 minutes) can be used.
      #
      # NOTE: Default is 0, which disables the setting
      #
      ignore_older: 480h

      #
      # JSON file format logging, used for docker : in accodance to filebeat
      # https://www.elastic.co/guide/en/beats/filebeat/current/configuration-filebeat-options.html#config-json
      #
      # json.keys_under_root: false
      # json.add_error_key: true
      # json.message_key: log

      # Adding of docker information to filebeat log
      processors:
      - add_kubernetes_metadata:
          in_cluster: true

  # Name of the registry file. Per default it is put in the current working
  # directory. In case the working directory is changed after when running
  # filebeat again, indexing starts from the beginning again.
  # registry_file: /var/lib/filebeat/registry

############################# Global Processors ##########################################

#
# The following example enriches each event with metadata from the cloud
# provider about the host machine. It works on EC2, GCE, DigitalOcean,
# Tencent Cloud, and Alibaba Cloud.
#
processors:
- add_cloud_metadata: ~

############################# Output ##########################################

# Configure what outputs to use when sending the data collected by the beat.
# Multiple outputs may be used.
output:

  ### Elasticsearch as output
  elasticsearch:
    # Array of hosts to connect to.
    # Scheme and port can be left out and will be set to the default (http and 9200)
    # In case you specify and additional path, the scheme is required: http://localhost:9200/path
    # IPv6 addresses should always be defined as: https://[2001:db8::1]:9200
    hosts: ["${ES_HOST}:${ES_PORT}"]

    # Optional protocol and basic auth credentials.
    protocol: "${ES_PROT}"
    username: "${ES_USER}"
    password: "${ES_PASS}"

    # Optional index name. The default is "filebeat" and generates
    # [filebeat-]YYYY.MM.DD keys.
    index: "${ES_INDEX}"

    # Compression of the submitted logs: 0-9, higher = more CPU usage
    # See: https://www.elastic.co/guide/en/beats/filebeat/current/elasticsearch-output.html#_compression_level
    #
    # NOTE: This is not supported in AWS Elasticsearch
    compression_level: ${ES_COMPRESSION}

    # The maximum number of events to bulk in a single Elasticsearch bulk API index request.
    bulk_max_size: ${ES_BATCHSIZE}

############################# Setup #########################################
# https://www.elastic.co/guide/en/beats/filebeat/6.2/configuration-template.html
# Configure setup for templates when index is changed by user.
# Multiple setup may be used.
setup:

  ### templates for setup
  template:
    # Name for template setup
    name: "${ES_TEMPLATE_NAME}"

    # Pattern for template setup
    pattern: "${ES_TEMPLATE_PATTERN}"

  ### Dashboard for setup
  # dashboards:
  #   # Pattern for the dashboard index
  #   index: "${DASH_INDEX}"


############################# Shipper #########################################

shipper:
  # The name of the shipper that publishes the network data. It can be used to group
  # all the transactions sent by a single shipper in the web interface.
  # If this options is not defined, the hostname is used.
  #name:

  # The tags of the shipper are included in their own field with each
  # transaction published. Tags make it easy to group servers by different
  # logical properties.
  #tags: ["service-X", "web-tier"]

  # Uncomment the following if you want to ignore transactions created
  # by the server on which the shipper is installed. This option is useful
  # to remove duplicates if shippers are installed on multiple servers.
  #ignore_outgoing: true

  # How often (in seconds) shippers are publishing their IPs to the topology map.
  # The default is 10 seconds.
  #refresh_topology_freq: 10

  # Expiration time (in seconds) of the IPs published by a shipper to the topology map.
  # All the IPs will be deleted afterwards. Note, that the value must be higher than
  # refresh_topology_freq. The default is 15 seconds.
  #topology_expire: 15

  # Configure local GeoIP database support.
  # If no paths are not configured geoip is disabled.
  #geoip:
    #paths:
    #  - "/usr/share/GeoIP/GeoLiteCity.dat"
    #  - "/usr/local/var/GeoIP/GeoLiteCity.dat"

#----------------------------- Console output ---------------------------------
#output.console:
  # Boolean flag to enable or disable the output module.
  #enabled: true

  # Pretty print json event
  #pretty: false

#================================ Logging ======================================
# There are three options for the log output: syslog, file, stderr.
# Under Windows systems, the log files are per default sent to the file output,
# under all other system per default to syslog.

# Sets log level. The default log level is info.
# Available log levels are: critical, error, warning, info, debug
logging.level: "${BEAT_LOGGING_LEVEL}"

# Enable debug output for selected components. To enable all selectors use ["*"]
# Other available selectors are "beat", "publish", "service"
# Multiple selectors can be chained.
#logging.selectors: ["*"]

# Send all logging output to syslog. The default is false.
#logging.to_syslog: true

# If enabled, metricbeat periodically logs its internal metrics that have changed
# in the last period. For each metric that changed, the delta from the value at
# the beginning of the period is logged. Also, the total values for
# all non-zero internal metrics are logged on shutdown. The default is true.
#logging.metrics.enabled: true

# The period after which to log the internal metrics. The default is 30s.
logging.metrics.period: "${BEAT_LOGGING_PERIOD}"

# # Logging to rotating files files. Set logging.to_files to false to disable logging to
# # files.
# logging.to_files: true
# logging.files:
#   # Configure the path where the logs are written. The default is the logs directory
#   # under the home path (the binary location).
#   path: /var/log/metricbeat

#   # The name of the files where the logs are written to.
#   name: metricbeat

#   # Configure log file size limit. If limit is reached, log file will be
#   # automatically rotated
#   rotateeverybytes: 10485760 # = 10MB

#   # Number of rotated log files to keep. Oldest files will be deleted first.
#   keepfiles: 10
